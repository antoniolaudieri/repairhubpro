import { serve } from "https://deno.land/std@0.168.0/http/server.ts";

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
};

// Database di definizioni malware - aggiornato regolarmente
const malwareDatabase = {
  version: "2024.12.26",
  lastUpdate: new Date().toISOString(),
  
  // Package names noti come malware/adware
  knownMalware: [
    // Trojan/Malware noti
    "com.android.providers.downloads.ui.fake",
    "com.android.system.fake",
    "com.android.vending.fake",
    "com.google.android.gms.fake",
    "com.security.update.fake",
    // Joker malware variants
    "com.imagecompress.android",
    "com.relax.relaxation.androide",
    "com.cheery.message.sendsms",
    "com.peason.lovinglovemessage",
    "com.file.recovefiles",
    "com.training.memorygame",
    // Harly malware
    "com.binbin.flashlight",
    "com.cool.flashlight",
    // Banking trojans
    "com.tct.weather.fake",
    "com.android.chrome.fake",
  ],
  
  // Adware/PUA noti
  knownAdware: [
    "com.cleanmaster.mguard",
    "com.piriform.ccleaner.fake",
    "com.dianxinos.optimizer",
    "com.nqmobile.antivirus20",
    "com.antivirus.tablet",
    "com.ksmobile.launcher",
    "com.apusapps.launcher",
    "com.qihoo.security",
    "com.qihoo360.mobilesafe",
  ],
  
  // Pattern sospetti nei nomi package
  suspiciousPatterns: [
    ".*\\.cleaner\\..*",
    ".*\\.booster\\..*",
    ".*\\.speedup\\..*",
    ".*\\.optimizer\\..*",
    ".*\\.antivirus\\.free.*",
    ".*\\.battery\\.saver.*",
    ".*\\.ram\\.clean.*",
    ".*\\.junk\\.clean.*",
    ".*\\.phone\\.cool.*",
    ".*\\.cpu\\.cool.*",
    ".*fake.*",
    ".*\\.hack\\..*",
    ".*\\.crack\\..*",
    ".*\\.cheat\\..*",
    ".*\\.mod\\.apk.*",
    ".*\\.free\\.coins.*",
    ".*\\.unlimited\\..*",
  ],
  
  // Pattern sospetti nei nomi app
  suspiciousAppNames: [
    "super cleaner",
    "phone cleaner",
    "ram booster",
    "battery saver pro",
    "speed booster",
    "junk cleaner",
    "virus cleaner",
    "free antivirus",
    "cpu cooler",
    "phone cooler",
    "master cleaner",
    "memory booster",
    "cache cleaner",
    "duplicate cleaner",
    "file cleaner",
    "power clean",
    "turbo cleaner",
    "max cleaner",
    "one cleaner",
    "smart cleaner",
  ],
  
  // Permessi ad alto rischio
  dangerousPermissionCombos: [
    // Combo: SMS + Internet = potenziale premium SMS fraud
    ["android.permission.SEND_SMS", "android.permission.INTERNET"],
    // Combo: Contacts + SMS = spam/phishing
    ["android.permission.READ_CONTACTS", "android.permission.SEND_SMS"],
    // Combo: Overlay + Accessibility = potenziale screen capture/keylogger
    ["android.permission.SYSTEM_ALERT_WINDOW", "android.permission.BIND_ACCESSIBILITY_SERVICE"],
    // Combo: Camera + Mic + Location = spyware
    ["android.permission.CAMERA", "android.permission.RECORD_AUDIO", "android.permission.ACCESS_FINE_LOCATION"],
  ],
  
  // Categorie di minaccia
  threatCategories: {
    malware: {
      severity: "critical",
      description: "Software malevolo che può danneggiare il dispositivo o rubare dati",
      action: "Disinstalla immediatamente"
    },
    trojan: {
      severity: "critical", 
      description: "App che si maschera come legittima ma esegue attività malevole",
      action: "Disinstalla immediatamente"
    },
    adware: {
      severity: "high",
      description: "App che mostra pubblicità invasive o traccia l'utente",
      action: "Consigliata rimozione"
    },
    pua: {
      severity: "medium",
      description: "App potenzialmente indesiderata - funzionalità dubbie o invasive",
      action: "Valuta la rimozione"
    },
    suspicious: {
      severity: "low",
      description: "App con comportamento sospetto da monitorare",
      action: "Monitora l'app"
    },
    safe: {
      severity: "none",
      description: "Nessuna minaccia rilevata",
      action: "Nessuna azione richiesta"
    }
  },
  
  // Store affidabili
  trustedSources: [
    "com.android.vending", // Google Play Store
    "com.sec.android.app.samsungapps", // Samsung Galaxy Store
    "com.amazon.venezia", // Amazon App Store
    "com.huawei.appmarket", // Huawei AppGallery
    "com.xiaomi.market", // Xiaomi GetApps
    "com.oppo.market", // OPPO App Market
    "com.vivo.appstore", // Vivo App Store
  ],
  
  // Whitelist app di sistema sicure
  systemAppWhitelist: [
    "com.google.",
    "com.android.",
    "com.samsung.",
    "com.sec.",
    "com.huawei.",
    "com.xiaomi.",
    "com.miui.",
    "com.oppo.",
    "com.vivo.",
    "com.oneplus.",
  ]
};

serve(async (req) => {
  // Handle CORS preflight
  if (req.method === 'OPTIONS') {
    return new Response(null, { headers: corsHeaders });
  }

  try {
    const { action } = await req.json().catch(() => ({ action: 'getAll' }));
    
    let responseData;
    
    switch (action) {
      case 'getVersion':
        responseData = {
          version: malwareDatabase.version,
          lastUpdate: malwareDatabase.lastUpdate
        };
        break;
        
      case 'checkPackage':
        const { packageName } = await req.json();
        const isMalware = malwareDatabase.knownMalware.includes(packageName);
        const isAdware = malwareDatabase.knownAdware.includes(packageName);
        responseData = {
          packageName,
          threat: isMalware ? 'malware' : isAdware ? 'adware' : 'unknown',
          found: isMalware || isAdware
        };
        break;
        
      case 'getAll':
      default:
        responseData = malwareDatabase;
        break;
    }

    console.log(`[malware-definitions] Action: ${action}, Response size: ${JSON.stringify(responseData).length} bytes`);

    return new Response(
      JSON.stringify(responseData),
      { 
        headers: { 
          ...corsHeaders, 
          'Content-Type': 'application/json',
          'Cache-Control': 'public, max-age=3600' // Cache per 1 ora
        } 
      }
    );
  } catch (error) {
    console.error('[malware-definitions] Error:', error);
    return new Response(
      JSON.stringify({ error: error instanceof Error ? error.message : 'Unknown error' }),
      { 
        status: 500, 
        headers: { ...corsHeaders, 'Content-Type': 'application/json' } 
      }
    );
  }
});
